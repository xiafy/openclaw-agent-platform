#!/usr/bin/env python3
"""
OpenClaw Agent è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…·
æ”¯æŒ L1 (Profile) å’Œ L2 (ç‹¬ç«‹ç”¨æˆ·) ä¸¤ç§æ¨¡å¼

ç”¨æ³•:
    # L1 éƒ¨ç½² (äº¤äº’å¼)
    ./deploy-agent --mode l1 --name researcher --role "å•†ä¸šç ”ç©¶å‘˜"
    
    # L2 éƒ¨ç½² (äº¤äº’å¼)
    ./deploy-agent --mode l2 --username wifey --role "å¤«äººåŠ©ç†"
    
    # é¢„æ¼”æ¨¡å¼
    ./deploy-agent --mode l2 --username test --dry-run
    
    # åˆ—å‡ºå·²éƒ¨ç½² Agent
    ./deploy-agent --list
"""

import argparse
import getpass
import sys
import os
from pathlib import Path

# æ·»åŠ  lib åˆ°è·¯å¾„
script_dir = Path(__file__).parent
lib_dir = script_dir.parent / 'lib'
sys.path.insert(0, str(lib_dir))

from config import ConfigManager
from deploy_l1 import L1Deployer
from deploy_l2 import L2Deployer
from verify import Verifier


def print_banner():
    """æ‰“å°æ¬¢è¿æ¨ªå¹…"""
    print("""
ğŸ¦€ OpenClaw Agent éƒ¨ç½²å·¥å…· v1.0

éƒ¨ç½²æ¨¡å¼:
  L1 - Profile (å¿«é€Ÿï¼Œ5 min)     é€‚åˆï¼šæµ‹è¯•/ä¸´æ—¶ Agent
  L2 - ç‹¬ç«‹ç”¨æˆ· (å®Œæ•´ï¼Œ30 min)   é€‚åˆï¼šç”Ÿäº§/é•¿æœŸ Agent
""")


def get_sudo_password():
    """å®‰å…¨è·å– sudo å¯†ç  (éšè—è¾“å…¥)"""
    print("ğŸ” éœ€è¦ sudo æƒé™æ¥é…ç½®ç³»ç»Ÿ")
    password = getpass.getpass("è¯·è¾“å…¥ sudo å¯†ç ï¼š")
    return password


def validate_args(args):
    """éªŒè¯å‘½ä»¤è¡Œå‚æ•°"""
    if args.mode == 'l2' and not args.username:
        print("âŒ L2 æ¨¡å¼å¿…é¡»æŒ‡å®š --username", file=sys.stderr)
        return False
    
    if not args.name and args.mode == 'l1':
        print("âŒ å¿…é¡»æŒ‡å®š --name", file=sys.stderr)
        return False
    
    return True


def main():
    parser = argparse.ArgumentParser(
        description='OpenClaw Agent è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…·',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  %(prog)s --mode l1 --name researcher --role "å•†ä¸šç ”ç©¶å‘˜"
  %(prog)s --mode l2 --username wifey --role "å¤«äººåŠ©ç†"
  %(prog)s --list
  %(prog)s --verify --name shuaishuai
        """
    )
    
    # éƒ¨ç½²æ¨¡å¼
    parser.add_argument('--mode', choices=['l1', 'l2'], help='éƒ¨ç½²æ¨¡å¼')
    
    # Agent ä¿¡æ¯
    parser.add_argument('--name', help='Agent åç§° (L1 æ¨¡å¼å¿…éœ€)')
    parser.add_argument('--role', help='Agent è§’è‰²æè¿°')
    parser.add_argument('--bot-token', help='Telegram Bot Token (å¯é€‰ï¼Œäº¤äº’å¼è¾“å…¥)')
    
    # L2 ç‰¹æœ‰
    parser.add_argument('--username', help='macOS ç”¨æˆ·å (L2 æ¨¡å¼)')
    parser.add_argument('--uid', type=int, help='ç”¨æˆ· ID (L2 æ¨¡å¼ï¼Œè‡ªåŠ¨åˆ†é…)')
    
    # é«˜çº§é€‰é¡¹
    parser.add_argument('--port', type=int, help='ç«¯å£å· (è‡ªåŠ¨åˆ†é…)')
    parser.add_argument('--dry-run', action='store_true', help='é¢„æ¼”æ¨¡å¼')
    parser.add_argument('--no-verify', action='store_true', help='è·³è¿‡éªŒè¯')
    parser.add_argument('--verbose', '-v', action='store_true', help='è¯¦ç»†è¾“å‡º')
    parser.add_argument('--list', action='store_true', help='åˆ—å‡ºå·²éƒ¨ç½² Agent')
    parser.add_argument('--verify', action='store_true', help='éªŒè¯æ¨¡å¼')
    
    args = parser.parse_args()
    
    # åˆ—å‡ºæ¨¡å¼
    if args.list:
        from utils import list_agents
        list_agents()
        return 0
    
    # éªŒè¯æ¨¡å¼
    if args.verify:
        if not args.name:
            print("âŒ éªŒè¯æ¨¡å¼å¿…é¡»æŒ‡å®š --name", file=sys.stderr)
            return 1
        verifier = Verifier(args.name)
        verifier.run()
        return 0
    
    # éªŒè¯å¿…éœ€å‚æ•°
    if not args.mode:
        print("âŒ å¿…é¡»æŒ‡å®š --mode (l1 æˆ– l2)", file=sys.stderr)
        return 1
    
    if not validate_args(args):
        return 1
    
    # æ‰“å°æ¨ªå¹…
    print_banner()
    
    # è·å–é…ç½®
    config = ConfigManager()
    
    # è·å– sudo å¯†ç  (ä»…åœ¨é dry-run æ¨¡å¼)
    sudo_password = None
    if not args.dry_run:
        sudo_password = get_sudo_password()
    
    # é€‰æ‹©éƒ¨ç½²å™¨
    if args.mode == 'l1':
        deployer = L1Deployer(config, args, sudo_password)
    else:  # l2
        deployer = L2Deployer(config, args, sudo_password)
    
    # æ‰§è¡Œéƒ¨ç½²
    try:
        print(f"\nğŸš€ å¼€å§‹éƒ¨ç½² {args.name or args.username} ({args.mode.upper()} æ¨¡å¼)...\n")
        
        if args.dry_run:
            print("ğŸ“‹ é¢„æ¼”æ¨¡å¼ - ä¸ä¼šå®é™…æ‰§è¡Œéƒ¨ç½²\n")
            deployer.dry_run()
        else:
            result = deployer.run()
            
            # éªŒè¯
            if result.success and not args.no_verify:
                print("\nâœ… éƒ¨ç½²å®Œæˆï¼Œå¼€å§‹éªŒè¯...\n")
                verifier = Verifier(result)
                verifier.run()
            
            # è¾“å‡ºæŠ¥å‘Š
            print_report(result)
        
        return 0
        
    except KeyboardInterrupt:
        print("\n\nâš ï¸  ç”¨æˆ·ä¸­æ–­ï¼Œå¼€å§‹å›æ»š...")
        deployer.rollback()
        return 1
    except Exception as e:
        print(f"\nâŒ éƒ¨ç½²å¤±è´¥ï¼š{e}")
        if not args.dry_run:
            print("ğŸ”„ å¼€å§‹å›æ»š...")
            deployer.rollback()
        if args.verbose:
            import traceback
            traceback.print_exc()
        return 1


def print_report(result):
    """æ‰“å°éƒ¨ç½²æŠ¥å‘Š"""
    print("\n" + "="*60)
    print("ğŸ“Š éƒ¨ç½²æŠ¥å‘Š")
    print("="*60)
    print(f"çŠ¶æ€ï¼š{'âœ… æˆåŠŸ' if result.success else 'âŒ å¤±è´¥'}")
    print(f"æ¨¡å¼ï¼š{result.mode.upper()}")
    print(f"åç§°ï¼š{result.agent_name}")
    
    if result.mode == 'l1':
        print(f"Profile: ~/.openclaw-{result.agent_name}")
    else:
        print(f"ç”¨æˆ·ï¼š{result.username}")
        print(f"UID: {result.uid}")
    
    print(f"ç«¯å£ï¼š{result.port}")
    print(f"Bot: @{result.bot_username}")
    print(f"Gateway: {'è¿è¡Œä¸­' if result.gateway_running else 'æœªè¿è¡Œ'}")
    
    if result.verify_report:
        print("\nğŸ“‹ éªŒè¯ç»“æœ:")
        for check in result.verify_report.checks:
            icon = "âœ…" if check.passed else "âŒ"
            print(f"  {icon} {check.name}")
    
    print("="*60)
    print(f"\nğŸ’¡ è®¿é—®ï¼šhttps://t.me/{result.bot_username}")
    print("="*60 + "\n")


if __name__ == '__main__':
    sys.exit(main())
